<view class="container">
  <!-- 加载状态 -->
  <view wx:if="{{isLoading}}" class="loading">
    <view class="loading-spinner"></view>
    <view class="loading-text">{{loadingText}}</view>
  </view>

  <!-- 器材信息卡片 -->
  <view wx:else class="equipment-container">
    <!-- 顶部状态卡片 -->
    <view class="status-card">
      <!-- 器材图片区域 -->
      <view class="equipment-image-container" bindtap="previewImage">
        <image 
          src="{{equipment.imageUrl || '/images/default-equipment.png'}}" 
          mode="widthFix" 
          class="equipment-image"
          wx:if="{{equipment.imageUrl || showDefaultImage}}"
        />
        <view class="no-image-placeholder" wx:if="{{!equipment.imageUrl && !showDefaultImage}}">
          <icon type="image" size="60" color="#ccc" />
        </view>
        <view class="image-preview-hint">点击图片放大查看</view>
      </view>

      <view class="status-card-header">
        <view class="equipment-name">{{equipment.name}}</view>
        <view class="equipment-type">{{equipment.type}}</view>
      </view>
      
      <view class="status-info">
        <view class="status-tag {{getStatusClass(equipment.status)}}">
          {{equipment.status}}
          <text wx:if="{{isOverdue}}" class="overdue-tag">已超期</text>
        </view>
        <view class="equipment-code">编码: {{equipment.code || '无编码'}}</view>
      </view>
    </view>

    <!-- 编辑按钮区域 -->
    <view wx:if="{{!fromRecycle}}" class="edit-button-container">
      <button class="edit-button" bindtap="goToEdit">
        <icon type="edit" size="24" color="#fff"></icon>
        <text>编辑器材信息</text>
      </button>
    </view>

    <!-- 基本信息卡片 -->
    <view class="info-card">
      <view class="info-card-title">基本信息</view>
      <view class="info-grid">
        <view class="info-item">
          <view class="info-label">系统ID</view>
          <view class="info-value light-text">{{equipment.id}}</view>
        </view>
        <view class="info-item">
          <view class="info-label">规格</view>
          <view class="info-value">{{equipment.specification || '-'}}</view>
        </view>
        <view class="info-item">
          <view class="info-label">数量</view>
          <view class="info-value">{{equipment.quantity}}</view>
        </view>
        <view class="info-item">
          <view class="info-label">存放位置</view>
          <view class="info-value">{{equipment.location || '-'}}</view>
        </view>
        <view class="info-item">
          <view class="info-label">备注</view>
          <view class="info-value">{{equipment.remarks || '-'}}</view>
        </view>
      </view>
    </view>

    <!-- 借用信息卡片 -->
    <view class="info-card" wx:if="{{equipment.status === '借出' && !fromRecycle}}">
      <view class="info-card-title">借用信息</view>
      <view class="borrow-info">
        <view class="borrow-info-row">
          <view class="borrow-label">借用人员</view>
          <view class="borrow-value">{{equipment.borrowInfo && equipment.borrowInfo.userName || '-'}}</view>
        </view>
        <view class="borrow-info-row">
          <view class="borrow-label">联系方式</view>
          <view class="borrow-value">{{equipment.borrowInfo && equipment.borrowInfo.userContact || '-'}}</view>
        </view>
        <view class="borrow-info-row">
          <view class="borrow-label">借用时间</view>
          <view class="borrow-value">{{equipment.borrowInfo && formatTime(equipment.borrowInfo.borrowTime) || '-'}}</view>
        </view>
        <view class="borrow-info-row">
          <view class="borrow-label">预计归还时间</view>
          <view class="borrow-value">{{equipment.borrowInfo && formatTime(equipment.borrowInfo.expectedReturnTime) || '-'}}
            <text wx:if="{{isOverdue}}" class="overdue-text">（已超期）</text>
          </view>
        </view>
        <view class="borrow-info-row">
          <view class="borrow-label">借用用途</view>
          <view class="borrow-value">{{equipment.borrowInfo && equipment.borrowInfo.purpose || '-'}}</view>
        </view>
      </view>
    </view>

    <!-- 归还/入库信息卡片 -->
    <view class="info-card" wx:if="{{equipment.status === '在库' && (equipment.returnInfo || equipment.warehousingInfo) && !fromRecycle}}">
      <view class="info-card-title">归还信息</view>
      <view class="borrow-info">
        <view class="borrow-info-row" wx:if="{{equipment.returnInfo}}">
          <view class="borrow-label">归还状态</view>
          <view class="borrow-value">{{equipment.returnInfo.condition || '-'}}</view>
        </view>
        <view class="borrow-info-row" wx:if="{{equipment.returnInfo}}">
          <view class="borrow-label">归还时间</view>
          <view class="borrow-value">{{equipment.returnInfo && formatTime(equipment.returnInfo.returnTime) || '-'}}</view>
        </view>
        <view class="borrow-info-row" wx:if="{{equipment.returnInfo && equipment.returnInfo.remarks}}">
          <view class="borrow-label">备注</view>
          <view class="borrow-value">{{equipment.returnInfo.remarks}}</view>
        </view>
      </view>
    </view>

    <!-- 删除信息卡片 -->
    <view class="info-card light-card" wx:if="{{fromRecycle}}">
      <view class="info-card-title">删除信息</view>
      <view class="borrow-info">
        <view class="borrow-info-row">
          <view class="borrow-label">删除时间</view>
          <view class="borrow-value">{{formatTime(equipment.deleteTime) || '-'}}</view>
        </view>
        <view class="borrow-info-row">
          <view class="borrow-label">删除原因</view>
          <view class="borrow-value">{{equipment.deleteReason || '-'}}</view>
        </view>
      </view>
    </view>

    <!-- 时间信息卡片 -->
    <view class="info-card light-card">
      <view class="info-card-title">时间记录</view>
      <view class="borrow-info">
        <view class="borrow-info-row">
          <view class="borrow-label">创建时间</view>
          <view class="borrow-value">{{formatTime(equipment.createTime) || '-'}}</view>
        </view>
        <view class="borrow-info-row">
          <view class="borrow-label">最后更新</view>
          <view class="borrow-value">{{formatTime(equipment.updateTime) || '-'}}</view>
        </view>
      </view>
    </view>

    <!-- 操作按钮区 - 移除转移位置按钮 -->
    <view class="action-buttons">
      <!-- 正常状态下的操作按钮 -->
      <view wx:if="{{!fromRecycle}}">
        <button 
          class="primary-button" 
          bindtap="showBorrowDialog"
          wx:if="{{equipment.status === '在库'}}"
        >
          借出
        </button>
        <button 
          class="primary-button" 
          bindtap="showReturnDialog"
          wx:if="{{equipment.status === '借出'}}"
        >
          归还
        </button>
        <button 
          class="danger-button" 
          bindtap="showDeleteDialog"
        >
          删除
        </button>
      </view>

      <!-- 回收站中的操作按钮 -->
      <view wx:if="{{fromRecycle}}">
        <button class="secondary-button" bindtap="restoreEquipment">
          恢复
        </button>
        <button class="danger-button" bindtap="permanentDelete">
          彻底删除
        </button>
      </view>
    </view>
  </view>

  <!-- 借出对话框 -->
  <view class="dialog-mask" wx:if="{{showBorrowDialog}}" bindtap="closeDialog" data-type="Borrow"></view>
  <view class="dialog-container" wx:if="{{showBorrowDialog}}">
    <view class="dialog-title">借出器材</view>
    
    <view class="form-group">
      <view class="form-label">借用人员</view>
      <input 
        class="form-control" 
        placeholder="请输入借用人员姓名" 
        value="{{borrowInfo.userName}}"
        bindinput="handleBorrowInput"
        data-field="userName"
      />
    </view>
    
    <view class="form-group">
      <view class="form-label">联系方式</view>
      <input 
        class="form-control" 
        placeholder="请输入联系电话" 
        value="{{borrowInfo.userContact}}"
        bindinput="handleBorrowInput"
        data-field="userContact"
      />
    </view>
    
    <view class="form-group">
      <view class="form-label">借用时间</view>
      <picker 
        mode="date" 
        start="{{minDate}}" 
        value="{{borrowInfo.borrowTime}}"
        bindchange="onDateChange"
        data-field="borrowTime"
      >
        <view class="form-control picker-control">
          {{borrowInfo.borrowTime || '请选择借用时间'}}
        </view>
      </picker>
    </view>
    
    <view class="form-group">
      <view class="form-label">预计归还时间</view>
      <picker 
        mode="date" 
        start="{{borrowInfo.borrowTime}}" 
        value="{{borrowInfo.expectedReturnTime}}"
        bindchange="onDateChange"
        data-field="expectedReturnTime"
      >
        <view class="form-control picker-control">
          {{borrowInfo.expectedReturnTime || '请选择预计归还时间'}}
        </view>
      </picker>
      <view class="form-hint">请选择最晚归还日期</view>
    </view>
    
    <view class="form-group">
      <view class="form-label">借用用途</view>
      <textarea 
        class="form-control" 
        placeholder="请输入借用用途（可选）" 
        value="{{borrowInfo.purpose}}"
        bindinput="handleBorrowInput"
        data-field="purpose"
      ></textarea>
    </view>
    
    <view class="dialog-buttons">
      <button class="dialog-button secondary-button" bindtap="closeDialog" data-type="Borrow">取消</button>
      <button class="dialog-button primary-button" bindtap="confirmBorrow">确认借出</button>
    </view>
  </view>

  <!-- 归还对话框 -->
  <view class="dialog-mask" wx:if="{{showReturnDialog}}" bindtap="closeDialog" data-type="Return"></view>
  <view class="dialog-container" wx:if="{{showReturnDialog}}">
    <view class="dialog-title">归还器材</view>
    
    <view class="form-group">
      <view class="form-label">归还时间</view>
      <picker 
        mode="date" 
        start="{{minDate}}" 
        value="{{returnInfo.returnTime}}"
        bindchange="onDateChange"
        data-field="returnTime"
      >
        <view class="form-control picker-control">
          {{returnInfo.returnTime || '请选择归还时间'}}
        </view>
      </picker>
    </view>
    
    <view class="form-group">
      <view class="form-label">器材状态</view>
      <picker 
        mode="selector" 
        range="{{returnConditionOptions}}"
        value="{{returnInfo.conditionIndex}}"
        bindchange="onReturnConditionChange"
      >
        <view class="form-control picker-control">
          {{returnConditionOptions[returnInfo.conditionIndex]}}
        </view>
      </picker>
    </view>
    
    <view class="form-group">
      <view class="form-label">备注</view>
      <textarea 
        class="form-control" 
        placeholder="请输入归还备注（可选）" 
        value="{{returnInfo.remarks}}"
        bindinput="handleReturnInput"
        data-field="remarks"
      ></textarea>
    </view>
    
    <view class="dialog-buttons">
      <button class="dialog-button secondary-button" bindtap="closeDialog" data-type="Return">取消</button>
      <button class="dialog-button primary-button" bindtap="confirmReturn">确认归还</button>
    </view>
  </view>

  <!-- 删除对话框 -->
  <view class="dialog-mask" wx:if="{{showDeleteDialog}}" bindtap="closeDialog" data-type="Delete"></view>
  <view class="dialog-container" wx:if="{{showDeleteDialog}}">
    <view class="dialog-title">删除器材</view>
    
    <view class="form-group">
      <view class="form-label">删除原因</view>
      <textarea 
        class="form-control" 
        placeholder="请输入删除原因" 
        value="{{deleteReason}}"
        bindinput="handleDeleteInput"
      ></textarea>
      <view class="form-hint">删除后器材将移至回收站</view>
    </view>
    
    <view class="dialog-buttons">
      <button class="dialog-button secondary-button" bindtap="closeDialog" data-type="Delete">取消</button>
      <button class="dialog-button danger-button" bindtap="confirmDelete">确认删除</button>
    </view>
  </view>
</view>
